#include <behaviors.dtsi>
#include <behaviors/unicode.dtsi>
#include <behaviors/num_word.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/pointing.h>
#include "zmk-helpers/helper.h"
#include "zmk-helpers/key-labels/34.h"

#define WIN 0
#define MAC 1
#define NAV 2
#define NAV_MAC 3
#define SYM 4
#define NUM 5
#define FUN 6
#define KBD 7

#define L_HOME(k1,k2,k3,k4) &mt LGUI  k1  &mt LALT  k2  &mt LCTRL k3  &mt LSHFT k4
#define R_HOME(k1,k2,k3,k4) &mt RSHFT k1  &mt RCTRL k2  &mt RALT  k3  &mt RGUI  k4
#define L_HOME_M(k1,k2,k3,k4) &mt LCTRL k1  &mt LALT  k2  &mt LGUI  k3  &mt LSHFT k4
#define R_HOME_M(k1,k2,k3,k4) &mt RSHFT k1  &mt RGUI  k2  &mt RALT  k3  &mt RCTRL k4

#define _ &trans
#define GBP UC_CURR_POUND

&uc {
  default-mode = <UC_MODE_WIN_ALT>;
};

&mt {
    flavor = "tap-preferred";
    tapping_term_ms = <150>;
};

&caps_word {
    continue-list = <UNDERSCORE MINUS BSPC DEL N1 N2 N3 N4 N5 N6 N7 N8 N9 N0>;
};

ZMK_MOD_MORPH(dot_excl, bindings = <&kp DOT>, <&kp EXCL>; mods = <(MOD_LSFT|MOD_RSFT)>;)
ZMK_MOD_MORPH(comma_ques, bindings = <&kp COMMA>, <&kp QUESTION>; mods = <(MOD_LSFT|MOD_RSFT)>;)
ZMK_MOD_MORPH(slash_both, bindings = <&kp SLASH>, <&kp BACKSLASH>; mods = <(MOD_LSFT|MOD_RSFT)>;)

ZMK_MACRO(win_mode, bindings = <&tog WIN &uc UC_SET_WIN_ALT>;)
ZMK_MACRO(mac_mode, bindings = <&tog MAC &uc UC_SET_MACOS>;)

#define DEL_WORD &kp LC(BSPC)
#define DEL_WORD_M &kp LA(BSPC)

#define SEL_ALL &kp LC(A)
#define SEL_ALL_M &kp LG(A)

#define UNDO &kp LC(Z)
#define UNDO_M &kp LG(Z)

#define REDO &kp LC(LS(Z))
#define REDO_M &kp LG(LS(Z))

#define CUT &kp LC(X)
#define CUT_M &kp LG(X)

#define COPY &kp LC(C)
#define COPY_M &kp LG(C)

#define PASTE &kp LC(V)
#define PASTE_M &kp LG(V)

ZMK_CONDITIONAL_LAYER(nav_mac_layer, MAC NAV, NAV_MAC)

// f + j = caps word
ZMK_COMBO(caps_word, &caps_word, LM1 RM1, ALL, 25)

// symbol layer + function layer = keyboard_layer
ZMK_CONDITIONAL_LAYER(kbd_layer, SYM FUN, KBD)

/ {
    behaviors {
        swap: swapper {
            compatible = "zmk,behavior-tri-state";
            label = "SWAPPER";
            #binding-cells = <0>;
            bindings = <&kt LALT>, <&kp TAB>, <&kt LALT>;
            ignored-key-positions = <LT1 LT2 RM0 RM1 RM2 RM3>;
        };
    };

    keymap {
        compatible = "zmk,keymap";

        windows_layer {
            bindings = <
            //                      ╭──────────┬──────────┬──────────┬──────────╮   ╭──────────┬──────────┬──────────┬──────────╮
            //                      │  W       │  E       │  R       │  T       │   │  Y       │  U       │  I       │  O       │
                                       &kp W      &kp E      &kp R      &kp T          &kp Y      &kp U      &kp I      &kp O     
            //╭──────────┬──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┬──────────╮
            //│  Q       │  A       │  S       │  D       │  F       │  G       │   │  H       │  J       │  K       │  L       │  ; :     │  P       │
                 &kp Q    L_HOME(A  ,  S       ,  D       ,  F       )  &kp G          &kp H    R_HOME(J  ,  K       ,  L       ,  SEMI    )  &kp P
            //╰──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┼──────────╯
            //           │  Z       │  X       │  C       │  V       │  B       │   │  N       │  M       │ , !      │ . ?      │  / \     │
                            &kp Z      &kp X      &kp C      &kp V      &kp B          &kp N      &kp M     &kp COMMA  &kp DOT   &kp SLASH
            //           ╰──────────┴──────────┴──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┴──────────┴──────────╯
            //                                            │  SPACE   │  ESCAPE  │   │  ENTER   │BACKSPACE │
                                                          &lt NAV SPC &lt SYM ESC   &lt FUN ENTER &lt NUM BSPC
            //                                            ╰──────────┴──────────╯   ╰──────────┴──────────╯
            >;
        };

        mac_layer {
            bindings = <
            //                      ╭──────────┬──────────┬──────────┬──────────╮   ╭──────────┬──────────┬──────────┬──────────╮
            //                      │  W       │  E       │  R       │  T       │   │  Y       │  U       │  I       │  O       │
                                       &kp W      &kp E      &kp R      &kp T          &kp Y      &kp U      &kp I      &kp O     
            //╭──────────┬──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┬──────────╮
            //│  Q       │  A       │  S       │  D       │  F       │  G       │   │  H       │  J       │  K       │  L       │  ; :     │  P       │
                 &kp Q    L_HOME_M(A,  S       ,  D       ,  F       )  &kp G          &kp H    R_HOME_M(J,  K       ,  L       ,  SEMI    )  &kp P
            //╰──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┼──────────╯
            //           │  Z       │  X       │  C       │  V       │  B       │   │  N       │  M       │ , !      │ . ?      │  / \     │
                            &kp Z      &kp X      &kp C      &kp V      &kp B          &kp N      &kp M    &kp COMMA   &kp DOT   &kp SLASH
            //           ╰──────────┴──────────┴──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┴──────────┴──────────╯
            //                                            │  SPACE   │  ESCAPE  │   │  ENTER   │BACKSPACE │
                                                          &lt NAV SPC &lt SYM ESC   &lt FUN ENTER &lt NUM BSPC
            //                                            ╰──────────┴──────────╯   ╰──────────┴──────────╯
            >;
        };

        navigation_layer {
            bindings = <
            //                      ╭──────────┬──────────┬──────────┬──────────╮   ╭──────────┬──────────┬──────────┬──────────╮
            //                      │          │<prev win>│<next win>│  REDO    │   │  HOME    │ PG DOWN  │  PG UP   │  END     │
                                       _       &kp LS(TAB)  &swapper    &REDO         &kp HOME  &kp PG_DOWN &kp PG_UP  &kp END      
            //╭──────────┬──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┬──────────╮
            //│SHIFT+TAB │          │          │          │          │  UNDO    │   │  LEFT    │  DOWN       UP      │  RIGHT   │          │  TAB     │
               &kp LS(TAB)  _          _          _          _          &UNDO         &kp LEFT   &kp DOWN    &kp UP   &kp RIGHT    _          &kp TAB   
            //╰──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┼──────────╯
            //           │          │SELECT ALL│  CUT     │  COPY    │  PASTE   │   │ PRNTSCRN │  DELETE  │  INSERT  │  MB4     │  MB5     │
                            _         &SEL_ALL    &CUT       &COPY      &PASTE       &kp PSCRN    &kp DEL    &kp INS   &mkp MB4   &mkp MB5
            //           ╰──────────┴──────────┴──────────█▀▀▀▀▀▀▀▀▀▀█──────────┤   ├──────────┼──────────┼──────────┴──────────┴──────────╯
            //                                            ▌          ▐          │   │          │ DEL WORD │
                                                             _          _              _        &DEL_WORD
            //                                            ▙▄▄▄▄▄▄▄▄▄▄▟──────────╯   ╰──────────┴──────────╯
            >;
        };

        navigation_mac_layer {
            bindings = <
            //                      ╭──────────┬──────────┬──────────┬──────────╮   ╭──────────┬──────────┬──────────┬──────────╮
            //                      │          │<prev win>│<next win>│  REDO    │   │  HOME    │ PG DOWN  │  PG UP   │  END     │
                                       _          _          _         &REDO_M         _          _          _          _
            //╭──────────┬──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┬──────────╮
            //│SHIFT+TAB │          │          │          │          │  UNDO    │   │  LEFT    │  DOWN       UP      │  RIGHT   │          │  TAB     │
                 _          _          _          _          _         &UNDO_M         _          _          _          _          _          _         
            //╰──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┼──────────╯
            //           │          │SELECT ALL│  CUT     │  COPY    │  PASTE   │   │ PRNTSCRN │  DELETE  │  INSERT  │  MB4     │  MB5     │
                            _        &SEL_ALL_M   &CUT_M    &COPY_M    &PASTE_M        _          _          _          _          _     
            //           ╰──────────┴──────────┴──────────█▀▀▀▀▀▀▀▀▀▀█──────────┤   ├──────────┼──────────┼──────────┴──────────┴──────────╯
            //                                            ▌          ▐          │   │          │ DEL WORD │
                                                             _          _              _       &DEL_WORD_M
            //                                            ▙▄▄▄▄▄▄▄▄▄▄▟──────────╯   ╰──────────┴──────────╯
            >;
        };

        symbol_layer {
            bindings = <
            //                      ╭──────────┬──────────┬──────────┬──────────╮   ╭──────────┬──────────┬──────────┬──────────╮
            //                      │  @       │  {       │  }       │  ^       │   │  REPEAT  │  -       │  (       │  )       │
                                      &kp AT     &kp LBRC   &kp RBRC  &kp CARET     &key_repeat  &kp MINUS  &kp LPAR   &kp RPAR
            //╭──────────┬──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┬──────────╮
            //│          │          │          │          │          │  &       │   │  #       │  =       │  _       │  "       │  '       │  `       │
                 _          _          _          _          _         &kp AMPS       &kp HASH  &kp EQUAL  &kp UNDER   &kp DQT    &kp SQT   &kp GRAVE
            //╰──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┼──────────╯
            //           │          │  <       │  >       │  :       │  |       │   │  ~       │  ;       │  [       │  ]       │          │
                            _          &kp LT     &kp GT   &kp COLON   &kp PIPE      &kp TILDE   &kp SEMI   &kp LBKT   &kp RBKT    _      
            //           ╰──────────┴──────────┴──────────┤──────────█▀▀▀▀▀▀▀▀▀▀█   ├──────────┼──────────┼──────────┴──────────┴──────────╯
            //                                            │          ▌          ▐   │          │          │
                                                             _          _              _          _         
            //                                            ╰──────────▙▄▄▄▄▄▄▄▄▄▄▟   ╰──────────┴──────────╯
            >;
        };

        number_layer {
            bindings = <
            //                      ╭──────────┬──────────┬──────────┬──────────╮   ╭──────────┬──────────┬──────────┬──────────╮
            //                      │    6     │    5     │    4     │          │   │  /       │  -       │  *       │  +       │
                                       &kp N6     &kp N5     &kp N4     _            &kp SLASH  &kp MINUS  &kp ASTRK   &kp PLUS
            //╭──────────┬──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┬──────────╮
            //│          │    3     │    2     │    1     │    0     │          │   │  =       │          │          │          │          │  .       │
                 _          &kp N3     &kp N2     &kp N1     &kp N0     _            &kp EQUAL    _          _          _          _         &kp DOT   
            //╰──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┼──────────╯
            //           │          │    9     │    8     │    7     │          │   │  $       │  £       │  %       │          │  ,       │
                            _          &kp N9     &kp N8     &kp N7     _            &kp DOLLAR  &uc GBP  &kp PERCENT   _        &kp COMMA
            //           ╰──────────┴──────────┴──────────┤──────────┼──────────┼   ├──────────█▀▀▀▀▀▀▀▀▀▀█──────────┴──────────┴──────────╯
            //                                            │          │ NUM WORD │   │          ▌          ▐
                                                             _       &num_word NUM     _          _         
            //                                            ╰──────────┴──────────╯   ╰──────────▙▄▄▄▄▄▄▄▄▄▄▟
            >;
        };

        function_layer {
            bindings = <
            //                      ╭──────────┬──────────┬──────── ─┬──────────╮   ╭──────────┬──────────┬──────────┬──────────╮
            //                      │    F6    │    F5    │    F4    │          │   │          │   MUTE   │ VOL DOWN │  VOL UP  │
                                       &kp F6     &kp F5     &kp F6     _              _       &kp C_MUTE &kp C_VOL_DN &kp C_VOL_UP   
            //╭──────────┬──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┬──────────╮
            //│   CAPS   │   F3     │    F2    │    F1    │   F10    │   F11    │   │          │PLAY/PAUSE│ PREVIOUS │   NEXT   │          │          │ 
                &kp CAPS    &kp N3     &kp F2     &kp F1    &kp F10    &kp F11         _         &kp C_PP  &kp C_PREV &kp C_NEXT   _          _   
            //╰──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┼──────────╯
            //           │          │    F9    │    F8    │    F7    │   F12    │   │          │          │BRIGHT DN │BRIGHT UP │          │
                            _          &kp F9     &kp F8     &kp F7    &kp F12         _          _      &kp C_BRI_DN &kp C_BRI_UP _       
            //           ╰──────────┴──────────┴──────────┤──────────┼──────────┼   █▀▀▀▀▀▀▀▀▀▀█──────────┼──────────┴──────────┴──────────╯
            //                                            │          │          │   ▌          ▐          │
                                                             _          _              _          _         
            //                                            ╰──────────┴──────────╯   ▙▄▄▄▄▄▄▄▄▄▄▟──────────╯
            >;
        };

        keyboard_layer {
            bindings = <
            //                      ╭──────────┬──────────┬──────────┬──────────╮   ╭──────────┬──────────┬──────────┬──────────╮
            //                      │          │          │  BT 4    │          │   │          │ OUT BLE  │ OUT USB  │          │
                                       _          _         &bt BT 4    _              _      &out OUT_BLE &out OUT_USB _       
            //╭──────────┬──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┬──────────╮
            //│          │  BT 3    │  BT 2    │  BT 1    │  BT 0    │          │   │          │ TOG WIN  │ TOG MAC  │          │          │          │   
                 _         &bt BT 3   &bt BT 2   &bt BT 1   &bt BT 0    _              _        &win_mode  &mac_mode    _          _          _
            //╰──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┼──────────╯
            //           │  BT CLR  │          │          │          │          │   │          │          │          │          │          │
                           &BT CLR     _          _          _          _              _          _          _          _          _
            //           ╰──────────┴──────────┴──────────┤──────────█▀▀▀▀▀▀▀▀▀▀█   █▀▀▀▀▀▀▀▀▀▀█──────────┼──────────┴──────────┴──────────╯
            //                                            │          ▌          ▐   ▌          ▐          │ 
                                                             _          _              _          _
            //                                            ╰──────────▙▄▄▄▄▄▄▄▄▄▄▟   ▙▄▄▄▄▄▄▄▄▄▄▟──────────╯ 
            >;
        }
    };
};

/* TODO:

- hyper mod-tap?
- maybe make home row mods on layers one shot

            //                      ╭──────────┬──────────┬──────────┬──────────╮   ╭──────────┬──────────┬──────────┬──────────╮
            //                      │          │          │          │          │   │          │          │          │          │
                                       _          _          _          _              _          _          _          _       
            //╭──────────┬──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┬──────────╮
            //│          │          │          │          │          │          │   │          │          │          │          │          │          │
                 _          _          _          _          _          _              _          _          _          _          _          _
            //╰──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤   ├──────────┼──────────┼──────────┼──────────┼──────────┼──────────╯
            //           │          │          │          │          │          │   │          │          │          │          │          │
                            _          _          _          _          _              _          _          _          _          _
            //           ╰──────────┴──────────┴──────────┤──────────┼──────────┼   ├──────────┼──────────┼──────────┴──────────┴──────────╯
            //                                            │          │          │   │          │          │
                                                             _          _              _          _         
            //                                            ╰──────────┴──────────╯   ╰──────────┴──────────╯
*/
